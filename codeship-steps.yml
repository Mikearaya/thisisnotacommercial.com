- name: Tag images
  type: serial
  encrypted_dockercfg_path: dockercfg.encrypted
  steps:
    - service: frontend
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/frontend"
      image_tag: "{{.Branch}}-latest"
      registry: docker.pkg.github.com
    - service: controlpanel
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/controlpanel"
      image_tag: "{{.Branch}}-latest"
      registry: docker.pkg.github.com
    - service: unchained
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/unchained"
      image_tag: "{{.Branch}}-latest"
      registry: docker.pkg.github.com

- name: Tag images as latest
  tag: develop
  type: serial
  encrypted_dockercfg_path: dockercfg.encrypted
  steps:
    - service: frontend
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/frontend"
      image_tag: "next"
      registry: docker.pkg.github.com
    - service: controlpanel
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/controlpanel"
      image_tag: "next"
      registry: docker.pkg.github.com
    - service: unchained
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/unchained"
      image_tag: "next"
      registry: docker.pkg.github.com

- name: Tag images as stable
  tag: master
  type: serial
  encrypted_dockercfg_path: dockercfg.encrypted
  steps:
    - service: frontend
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/frontend"
      image_tag: "stable"
      registry: docker.pkg.github.com
    - service: controlpanel
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/controlpanel"
      image_tag: "stable"
      registry: docker.pkg.github.com
    - service: unchained
      type: push
      image_name: "registry.ucc.dev/thisisnotacommercial/website/unchained"
      image_tag: "stable"
      registry: docker.pkg.github.com

- name: Deploy to Testing
  tag: develop
  type: serial
  services:
    - unchaineddeployment
  steps:
    - command: /bin/sh -c '/swarmpit_deploy.sh thisisnotacommercial-test "${SWARMPIT_TOKEN}"'

- name: Deploy to Production
  tag: master
  type: serial
  services:
    - unchaineddeployment
  steps:
    - command: /bin/sh -c '/swarmpit_deploy.sh thisisnotacommercial-prod "${SWARMPIT_TOKEN}"'
